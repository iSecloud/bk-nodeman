spec_version: 2
app_version: "{{APP_VERSION}}"
app:
    region: default
    bk_app_code: "bk-nodeman-k8s"
    bk_app_name: 节点管理容器部署版
    market:
        category: 运维工具
        introduction: 通过节点管理，可以对蓝鲸体系中的gse agent进行管理，包括状态查询、版本更新、配置管理、健康检查、进程管理等。
        display_options:
            width: 1300
            height: 720
            is_win_maximize: True
            open_mode: "new_tab"
modules:
    default:
        is_default: True
        source_dir: src
        language: Python
        services:
            - name: mysql
        processes:
            web:
                command: gunicorn wsgi -w 4 -b :5000 --access-logfile - --error-logfile - --access-logformat '[%(h)s] %({request_id}i)s %(u)s %(t)s "%(r)s" %(s)s %(D)s %(b)s "%(f)s" "%(a)s"'
                plan: 4C2G5R
                replicas: 5

    backend:
        is_default: False
        source_dir: src
        language: Python
        services:
            - name: rabbitmq
            - name: redis
            - name: mysql
              shared_from: default
        env_variables:
            - key: BK_BACKEND_CONFIG
              value: True
              description: 是否启用后台配置，用于同一份代码区分SaaS和后台的差异化配置

        processes:
            backend-web:
                command: gunicorn --timeout 300 -w 8 -b :5000 -k gevent wsgi:application --access-logfile - --error-logfile - --access-logformat '[%(h)s] %({request_id}i)s %(u)s %(t)s "%(r)s" %(s)s %(D)s %(b)s "%(f)s" "%(a)s"'
                plan: 4C2G5R
                replicas: 5
            celery-beat:
                command: celery -A apps.backend beat -l info
                plan: 4C2G5R
                replicas: 1
            celery-worker-default:
                command: celery -A apps.backend worker -Q default --autoscale=8,2 --maxtasksperchild=50 -O fair --time-limit=1800
                plan: 4C2G5R
                replicas: 5
            celery-worker-backend:
                command: celery -A apps.backend worker -Q backend  --autoscale=16,2 --maxtasksperchild=50 -O fair --time-limit=1800
                plan: 4C2G5R
                replicas: 5
            celery-worker-backend-a:
                command: celery -A apps.backend worker -Q backend_additional_task -c 10 -O fair --time-limit=1800 --maxtasksperchild=50
                plan: 4C2G5R
                replicas: 5
            celery-worker-pipeline:
                command: celery -A apps.backend worker -Q pipeline,pipeline_priority -n pipeline_worker@%h --maxtasksperchild=50 --autoscale=16,2 -O fair --time-limit=1800
                plan: 4C2G5R
                replicas: 5
            celery-worker-pipeline-schedule:
                command: celery -A apps.backend worker -Q service_schedule,service_schedule_priority -n schedule_worker@%h --maxtasksperchild=50 -c 50 -P eventlet -O fair --time-limit=1800
                plan: 4C2G5R
                replicas: 5
            celery-worker-pipeline-a:
                command: celery -A apps.backend worker -Q pipeline_additional_task,pipeline_additional_task_priority -n common_worker@%h -l info --autoscale=16,2 --maxtasksperchild=50 -O fair --time-limit=1800
                plan: 4C2G5R
                replicas: 5
